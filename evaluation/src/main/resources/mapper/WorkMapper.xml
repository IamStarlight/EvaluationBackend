<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http#{//mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.evaluation.mapper.WorkMapper">

    <select id="getAllWorkInfoBySid" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        SELECT wid,cname,title,details,start_time,end_time,status,url,submit_number
        FROM homework,sc,course
        WHERE sc.sid=#{sid}
        AND homework.cid=sc.cid
        AND homework.cid=course.cid;
    </select>

    <select id="getAllWorkInfoByCid" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        SELECT wid,cname,title,details,start_time,end_time,status,url,submit_number,status
        FROM homework,course
        WHERE homework.cid=course.cid
        AND homework.cid=#{cid}
    </select>

    <select id="getWorkInfoById" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        select wid,cname,title,details,end_time,submit_number,class_number,status
        from homework,course
        where homework.cid=course.cid
        and homework.cid=#{cid}
        and wid=#{wid}
    </select>

    <insert id="createNewWork">
        insert into homework(wid,cid,title,details,start_time,end_time,status,url)
        values (#{wid},#{cid},#{title},#{details},#{startTime},#{endTime},#{status},#{url})
    </insert>

    <update id="updateVisible">
        update homework
        set status=#{status}
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <select id="getAllWorkInfoByTid" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        SELECT wid,cname,title,details,start_time,end_time,status,url,submit_number
        FROM homework,course
        WHERE course.tid=#{id}
        AND homework.cid=course.cid;
    </select>

    <select id="getStuWorkInfo" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        select homework.wid,cname,homework.title,homework.end_time,status,eva_status,total_grade,is_submit,is_read,is_appeal
        from homework,course,sc,stu_homework
        where homework.cid=#{cid}
        and sc.sid=#{sid}
        and homework.cid=sc.cid
        and sc.cid=course.cid
        and homework.cid=stu_homework.cid
        and sc.sid=stu_homework.sid
        and homework.wid=stu_homework.wid
    </select>

    <update id="updateOpenPeer">
        update homework
        set eva_status=#{status},peer_ddl=#{ddl}
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <select id="getOneWorkInfoBySid" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        SELECT wid,cname,title,details,start_time,end_time,status,url,submit_number
        FROM homework,sc,course
        WHERE sc.sid=#{id}
        AND homework.wid=#{wid}
        AND homework.cid=sc.cid
        AND homework.cid=course.cid;
    </select>

    <select id="getAllDraftWorkInfoByTid" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        SELECT wid,cname,title,details,start_time,end_time,status,url,submit_number
        FROM homework,course
        WHERE course.tid=#{id}
        AND status=1
        AND homework.cid=course.cid;
    </select>

    <select id="getSubmitNumber" resultType="java.lang.Integer">
        select submit_number
        from homework
        where wid=#{wid}
        and cid=#{cid}
    </select>

    <update id="updateSubmitNumber">
        update homework
        set submit_number=#{newNumber}
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <update id="statusToRelease">
        update homework
        set status=2
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <update id="statusToEnd">
        update homework
        set status=3
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <select id="getDeadline" resultType="java.lang.String">
        select eva_ddl
        from homework
        where wid=#{wid}
        and cid=#{cid}
    </select>

    <update id="evaStatusToEnd">
        update homework
        set eva_status=3
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <update id="addEvaNumber">
        update homework
        set eva_number=eva_number+1
        where wid=#{wid}
        and cid=#{cid}
    </update>

    <select id="getHomeworkOpenEva" resultType="com.example.evaluation.entity.Homework">
        select wid,cid,eva_ddl
        from homework
        where eva_status=2
    </select>

    <select id="getHomeWorkUsingTimer" resultType="com.example.evaluation.entity.Homework">
        select wid,cid,start_time,end_time
        from homework
        where status=4
    </select>

    <select id="getHomeworkHasReleased" resultType="com.example.evaluation.controller.dto.HomeworkInfo">
        select wid,cid,end_time
        from homework
        where status=2
    </select>
</mapper>
